# schema与数据类型优化


更小的通常更好 0-200  tinyint unsigned 更好
修改数据类型是一个耗时的操作

内建类型 存储时间和日期  整形存储ip

避免null 最好指定列为not null 

timestamp 只使用 datetime 一半的存储空间 会根据时区变化 自动更新 但  timestamp允许的时间范围小 

tinyint smallint mediumintint int bigint
分别对应8 16 24 32 64 围存储空间 存储范围-2的（N-1）到2的（N-1）-1 N为存储空间的位数

unsigned 不允许负数

INT（11) 不会限制值的范围 只规定一些交互工具用来显示字符的合法范围 对应存储和计算来说 INT（1）和INT（20）是相同的

DECIMAL 只是一种存储格式 计算中DECIMAL会转换成DOUBLE类型  数据量较大时考虑用BIGINT代替DECIMAL 乘以一百万

varchar 需要使用额外的1-2个字节记录字符串的长度 如果长度小于255字节 使用1个字节记录长度 否则 2个字节记录长度

char 适合存储MD5值 不容易产生碎片 

varchar(5) 和 varchar(200) 
存储"hello"时 空间开销一样 
但 更长的列会消耗更多的内存 内存临时表或者磁盘临时表 排序或者操作时会很糟糕

BLOB和TEXT 都是为存储很大数据设计的字符串数据类型 分别采用二进制和字符方式储存
当值太大 INNODB会使用专门外部的存储区域来存储 在行内存1-4个字节的指针 在外部存实际的值
只对每个列最前面max_sort_length字节而不是整个字符串进行排序

enum 枚举
枚举可以把一些不重复的字符串存储为一个预定义的集合 
MYSQL内部将每个值在列表中的位置保存为整数  保存为 数字 - 字符串 映射关系的查找表
枚举字段是按照内存存储的整数而不是定义的字符串进行排序的
使用enum可以让表缩小1/3

通用的设计实践 在查找表时 采用整数主键避免采用基于字符串的值进行关联

mysql储存的最小时间粒度为秒
mariaBD支持微秒级别的时间类型

datetime 1001-9999 8个字节存储空间
timestamp 1970-2038 4个字节存储空间 没指定时 自动设置为当前时间 插入时也会更新第一个TIMESTAMP值
unix 时间戳存储为整数值 不会有任何收益

比秒更小的时间可以用BIGINT存时间戳

选择标识符
MYSQL内部使用整数存储ENUM和SET类型 然后做比较操作时转换成字符串
所有关联表中同样的类型 包括unsigned 
满足值的范围需求 预留未来增长空间
整数 是标识类的最好选择 很快 还可以使用autoincrement
enum和set类型 比如性别
字符串类型 耗空间 比数字慢 MYISAM对字符串使用压缩索引 导致查询慢
ip地址实际是32位无符号整数 不是字符串 
小数点分成四段的表示方法是为了让人们容易阅读 无符号的整数存储IP地址 inet_aton() inet_ntoa()来切换

不好的设计
列太多
关联太多 MYSQL限制关联操作最多只能61张表 查询快速并发好 单个查询最好在12个表以内
枚举 增加一个新的值时 需要alter table
mysql 处理null不容易 设置成0 “” 特殊值

范式优点
更新操作比反范式快
很少有重复的数据
范式化表小 更好的放在内存 执行操作更快
较少多余的数据 减少DISTINCT或者GROUP BY语句

范式缺点
通常需要关联

反范式  所有数据读在一张表里  意味着重复数据 
采用反范式组织数据 高效 不需要联表查询

计数器表
update hit_counter set cnt = cnt + 1;
更新时 这条记录会有一个全局的互斥锁 事务只能串行执行
更高的并发 更高的性能 
计数器保存在多行中 每次随机一行更新
update hit_counter set cnt = cnt + 1 where slot = RAND() * 100;
select sum(cnt) from hit_counter;

为了提高读查询速度 建索引 增加冗余 增加写的负担 但提高了读了性能

alter table 操作的性能对达标来说是个问题 会锁表和重建表
MYSQL 执行大部分修改表结构的方法是用新的结构创建一个空表 从旧表中查出所有数据 插入新表 然后删除旧表
ALTER 要数小时 或者数天才能完成
常用alter技巧 1：在不提供服务的机器上执行alter 然后和主库切换  2：影子拷贝 新建表 重命名 交换俩张表

小心使用enum 和 set  避免使用BIT








