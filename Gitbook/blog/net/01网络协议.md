协议，是人类和计算机沟通的协议，只有通过这种协议，计算机才知道我们想让它做什么。

协议三要素
这种协议还是更接近人类语言，机器不能直接读懂，需要进行翻译，翻译的工作教给编译器，也就是compile

计算机语言作为程序员控制一台计算机工作的协议，具备了协议的三要素。

语法，就是这一段内容要符合一定的规则和格式。例如，括号要成对，结束要使用分号等。

语义，就是这一段内容要代表某种意义。例如数字减去数字是有意义的，数字减去文本一般来说就没有意义。

顺序，就是先干啥，后干啥。例如，可以先加上某个数值，然后再减去某个数值。

会了计算机语言，你就能够教给一台计算机完成你的工作了

互联网世界需要学会教给一大片机器做什么。这就需要网络协议
只有通过网络协议，才能使一大片机器互相协作、共同完成一件事。

浏览器收到了一段来自 HTTP 协议的“东西”

HTTP/1.1 200 OK
Date: Tue, 27 Mar 2018 16:50:26 GMT
Content-Type: text/html;charset=UTF-8
Content-Language: zh-CN

<!DOCTYPE html>
<html>
<head>
<base href="https://pages.kaola.com/" />
<meta charset="utf-8"/> <title> 网易考拉 3 周年主会场 </title>
这符合协议的三要素

首先，符合语法，也就是说，只有按照上面那个格式来，浏览器才认。例如，上来是状态，然后是首部，然后是内容。

第二，符合语义，就是要按照约定的意思来。例如，状态 200，表述的意思是网页成功返回。如果不成功，就是我们常见的“404”。

第三，符合顺序，你一点浏览器，就是发送出一个 HTTP 请求，然后才有上面那一串 HTTP 返回的东西。

浏览器显然按照协议商定好的做了

常用的网络协议

在浏览器里面输入 https://www.kaola.com ，这是一个URL
浏览器只知道名字是“www.kaola.com”，但是不知道具体的地点，所以不知道应该如何访问
于是，它打开地址簿去查找。可以使用一般的地址簿协议DNS去查找，还可以使用另一种更加精准的地址簿查找协议HTTPDNS。

无论用哪一种方法查找，最终都会得到这个地址：106.114.138.24
这个是IP地址，是互联网世界的“门牌号”

知道了目标地址，浏览器就开始打包它的请求
对于普通的浏览请求，往往会使用HTTP协议
但是对于https的请求，需要进行加密传输，因而会使用HTTPS协议。无论是什么协议，里面都会写明内容

应用层
DNS、HTTP、HTTPS 所在的层我们称为应用层

传输层
经过应用层封装后，浏览器会将应用层的包交给下一层去完成
通过 socket 编程来实现
下一层是传输层
传输层有两种协议
一种是无连接的协议UDP
一种是面向连接的协议TCP

对于支付来讲，往往使用 TCP 协议
所谓的面向连接就是，TCP 会保证这个包能够到达目的地
如果不能到达，就会重新发送，直至到达。

TCP 协议里面会有两个端口
一个是浏览器监听的端口，一个是服务器监听的端口
操作系统往往通过端口来判断，它得到的包应该给哪个进程。

网络层
传输层封装完毕后，浏览器会将包交给操作系统的网络层
网络层的协议是 IP 协议
在 IP 协议里面会有源 IP 地址，即浏览器所在机器的 IP 地址和目标 IP 地址，也即网站所在服务器的 IP 地址。


操作系统既然知道了目标 IP 地址，就开始想如何根据这个门牌号找到目标机器
操作系统往往会判断，这个目标 IP 地址是本地，还是外地
如果是本地，从门牌号就能看出来，但是显然网站不在本地，而在遥远的地方。

操作系统知道要离开本地去远方。虽然不知道远方在何处
但是可以这样类比一下：如果去国外要去海关，去外地就要去网关
而操作系统启动的时候，就会被 DHCP 协议配置 IP 地址，以及默认的网关的 IP 地址 192.168.1.1

操作系统如何将 IP 地址发给网关呢？
在本地通信基本靠吼，于是操作系统大吼一声，谁是 192.168.1.1 啊？
网关会回答它，我就是，我的本地地址是***
这个本地地址就是MAC地址，而大吼的那一声是ARP协议。


MAC层
于是操作系统将 IP 包交给了下一层，也就是MAC 层。网卡再将包发出去。由于这个包里面是有 MAC 地址的，因而它能够到达网关。

网关收到包之后，会根据自己的知识，判断下一步应该怎么走
网关往往是一个路由器，到某个 IP 地址应该怎么走，这个叫作路由表。
路由器之间靠源 IP 地址和 目标 IP 地址 进行沟通
这种沟通的协议称为路由协议，常用的有OSPF和BGP

经过很多路由器的传输 最后一个路由器知道这个网络包要去的地方
于是，对着内部吼一声，谁是目标 IP 啊？
目标服务器就会回复一个 MAC 地址。网络包过关后，通过这个 MAC 地址就能找到目标服务器。

目标服务器发现 MAC 地址对上了，取下 MAC 头来，发送给操作系统的网络层
发现 IP 也对上了，就取下 IP 头
IP 头里会写上一层封装的是 TCP 协议，然后将其交给传输层，即TCP 层。

在这一层里，对于收到的每个包，都会有一个回复的包说明收到了
这个回复的包绝非这次请求的结果，例如购物是否成功，扣了多少钱等
而仅仅是 TCP 层的一个说明，即收到之后的回复。当然这个回复，会沿着刚才来的方向走回去，报个平安。

如果在这个过程中，网络包走丢了，因而到了要报个平安

如果过一段时间还是没到，发送端的 TCP 层会重新发送这个包
还是上面的过程，直到有一天收到平安到达的回复
这个重试绝非你的浏览器重新将下单这个动作重新请求一次
对于浏览器来讲，就发送了一次下单请求，TCP 层不断自己闷头重试

除非 TCP 这一层出了问题，例如连接断了，才轮到浏览器的应用层重新发送下单请求。

当网络包平安到达 TCP 层之后，TCP 头中有目标端口号
通过这个端口号，可以找到电商网站的进程正在监听这个端口号
假设一个 Tomcat，将这个包发给网站的进程

网站的进程得到 HTTP 请求的内容，知道了要买东西，买多少
往往一个网站最初接待请求的这个 Tomcat 只是个接待员
负责统筹处理这个请求，而不是所有的事情都自己做
例如，这个接待员要告诉专门管理订单的进程，登记要买某个商品，买多少
要告诉管理库存的进程，库存要减少多少，要告诉支付的进程，应该付多少钱，等等。

如果告诉相关的进程呢？
往往通过 RPC 调用，即远程过程调用的方式来实现。远程过程调用就是当告诉管理订单进程的时候
接待员不用关心中间的网络互连问题，会由 RPC 框架统一处理
RPC 框架有很多种，有基于 HTTP 协议放在 HTTP 的报文里面的，有直接封装在 TCP 报文里面的。

当接待员发现相应的部门都处理完毕，就回复一个 HTTPS 的包，告知下单成功
这个 HTTPS 的包，会像来的时候一样，经过千难万险到达你的个人电脑，最终进入浏览器，显示支付成功。

小结
看到了吧，一个简简单单的下单过程，中间牵扯到这么多的协议
而管理一大片机器，更是一件特别有技术含量的事情
除此之外，像最近比较火的云计算、容器、微服务等技术，也都需要借助各种协议，来达成大规模机器之间的合作。
